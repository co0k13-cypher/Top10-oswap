# Exploiting server-side template injection vulnerabilities.

## Read.

- Việc đọc tài liệu của Template engines là bước quan trọng để hiểu và thực hiện các bước tấn công tiếp theo. 

### Learn the basic template syntax.

- Học cú pháp cơ bản là quan trọng, cùng với các hàm chính và xử lý các biến. Ngay cả những thứ đơn giản như học cách nhúng các khối mã gốc vào mẫu đôi khi cũng có thể nhanh chóng dẫn đến việc bị lợi dụng.

- VD mako python:

```
<%
	import os
	x=os.popen('id').read()
%>
${x}
```

- Lab:
	+ Lab: Basic server-side template injection.[exploit](exploit/lab1.py)
	+ Lab: Basic server-side template injection (code context).[exploit](exploit/lab2.py)

### Read about the security implications.

- Ngoài việc cung cấp các nguyên tắc cơ bản về cách tạo và sử dụng các mẫu, tài liệu cũng có thể cung cấp một số gợi ý "Bảo mật". Nó thường sẽ mô tả tất cả những điều nguy hiểm có thể xảy ra mà mọi người nên tránh làm với mẫu. Đây có thể là một nguồn tài nguyên vô giá, thậm chí đóng vai trò như một loại bảng gian lận mà bạn nên tìm kiếm trong quá trình kiểm toán, cũng như cách khai thác chúng.

- Ngay cả khi không có phần "Bảo mật" dành riêng, nếu một đối tượng hoặc chức năng tích hợp cụ thể có thể gây ra rủi ro bảo mật, thì hầu như luôn có một cảnh báo nào đó trong tài liệu. Cảnh báo có thể không cung cấp nhiều chi tiết, nhưng ít nhất nó cũng cung cấp một gợi ý cho việc tấn công.

- VD ERB:

```
<%= Dir.entries('/') %>
<%= File.open('/example/arbitrary-file').read %>
```
-Lab:
	+ Lab: Server-side template injection using documentation.[exploit](exploit/lab3.py)

### Look for known exploits.

- Một khía cạnh quan trọng khác của việc khai thác lỗ hổng SSTI là khả năng tìm kiếm các tài nguyên bổ sung trên mạng. Khi bạn có thể xác định công cụ mẫu đang được sử dụng, bạn tìm bất kỳ lỗ hổng nào mà những người khác có thể đã phát hiện ra. Do việc sử dụng rộng rãi một số công cụ mẫu chính, đôi khi có thể tìm thấy các khai thác được ghi chép đầy đủ mà bạn có thể chỉnh sửa để khai thác trang web mục tiêu của riêng mình.

- Lab:
	+ Lab: Server-side template injection in an unknown language with a documented exploit.[exploit](exploit/lab4.py)


## Explore.

- Khám phá môi trường và cố gắng khám phá tất cả các đối tượng mà bạn có quyền truy cập.

- Nhiều công cụ mẫu hiển thị một đối tượng "self" hoặc "environment" hoạt động giống như một không gian tên chứa tất cả các đối tượng, phương thức và thuộc tính được hỗ trợ bởi công cụ mẫu.

- Ví dụ: Liệt kê các biến môi trường trong JAVA.

> ${T(java.lang.System).getenv()}

### Developer-supplied objects.

- Điều quan trọng cần lưu ý là các trang web sẽ chứa cả các đối tượng tích hợp được cung cấp bởi mẫu và các đối tượng tùy chỉnh, dành riêng cho trang web đã được nhà phát triển web cung cấp. 
- Bạn nên chú ý các đối tượng không chuẩn này vì chúng có khả năng chứa thông tin nhạy cảm hoặc các phương pháp có thể khai thác. 

- Mặc dù SSTI có thể dẫn đến RCE và tiếp quản toàn bộ máy chủ, nhưng trong thực tế, điều này không phải lúc nào cũng có thể đạt được. Tuy nhiên, chỉ vì RCE không xảy ra điều đó không có nghĩa là không có tiềm năng cho một tấn công khác. Bạn vẫn có thể tận dụng các lỗ hổng SSTI để khai thác như duyệt qua thư mục để có được quyền truy cập vào dữ liệu nhạy cảm.

- Lab:
	+ Lab: Server-side template injection with information disclosure via user-supplied objects.[exploit](exploit/lab5.py)

## Create a custom attack.

- Đôi khi bạn sẽ cần phải xây dựng một khai thác tùy chỉnh. Ví dụ: bạn có thể thấy rằng công cụ mẫu thực thi các mẫu bên trong hộp cát, điều này có thể gây khó khăn cho việc khai thác hoặc thậm chí là không thể.

- Sau khi xác định bề mặt tấn công, nếu không có cách rõ ràng để khai thác lỗ hổng, bạn nên tiến hành các kỹ thuật kiểm tra truyền thống bằng cách xem xét từng chức năng để biết hành vi có thể khai thác.

### Constructing a custom exploit using an object chain.

- Bước đầu tiên là xác định các đối tượng và phương thức mà bạn có quyền truy cập. Bằng cách kết hợp kiến ​​thức của riêng bạn và thông tin được cung cấp trong tài liệu, bạn sẽ có thể tập hợp một danh sách rút gọn các đối tượng có tiềm năng.

- Khi nghiên cứu tài liệu các đối tượng, hãy chú ý đến phương thức mà các đối tượng này cấp quyền truy cập, cũng như đối tượng  trả về. Việc liên kết các đối tượng và phương pháp phù hợp với nhau đôi khi cho phép bạn có quyền truy cập vào chức năng nguy hiểm và dữ liệu nhạy cảm.

-VD: Khai thác trong ava Velocity.

> $class.inspect("java.lang.Runtime").type.getRuntime().exec("bad-stuff-here")

- Lab:
	+ Lab: Server-side template injection in a sandboxed environment.[exploit](exploit/lab6.py)

### Constructing a custom exploit using developer-supplied objects.

- Lab:
	+ Lab: Server-side template injection with a custom exploit.[exploit](exploit/lab7.py)